<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>Gnumeric/Pure: A Pure Plugin for Gnumeric</title>
<meta name="author" content="Albert Gräf" />
<meta name="copyright" content="Copyright (c) 2009. This software is distributed under the GNU Public License V2 or later, see the COPYING file for details." />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5631 2008-08-24 13:01:23Z goodger $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="gnumeric-pure-a-pure-plugin-for-gnumeric">
<h1 class="title">Gnumeric/Pure: A Pure Plugin for Gnumeric</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Albert Gräf</td></tr>
<tr><th class="docinfo-name">Contact:</th>
<td><a class="first last reference external" href="mailto:Dr.Graef&#64;t-online.de">Dr.Graef&#64;t-online.de</a></td></tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>Copyright (c) 2009. This software is distributed under the GNU
Public License V2 or later, see the COPYING file for details.</td></tr>
</tbody>
</table>
<p>Gnumeric/Pure is a <a class="reference external" href="http://www.gnumeric.org/">Gnumeric</a> extension which lets you use <a class="reference external" href="http://pure-lang.googlecode.com/">Pure</a> functions in
Gnumeric, the Gnome spreadsheet. It offers better execution speed than the
existing Perl and Python plugins, and provides some powerful features not
found in other Gnumeric scripting plugins, such as asynchronous data sources
created from Pure streams and OpenGL rendering in Gnumeric frame widgets via
Pure's OpenGL module.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#introduction" id="id1">1&nbsp;&nbsp;&nbsp;Introduction</a></li>
<li><a class="reference internal" href="#installation" id="id2">2&nbsp;&nbsp;&nbsp;Installation</a></li>
<li><a class="reference internal" href="#setup" id="id3">3&nbsp;&nbsp;&nbsp;Setup</a></li>
<li><a class="reference internal" href="#basic-usage" id="id4">4&nbsp;&nbsp;&nbsp;Basic Usage</a></li>
<li><a class="reference internal" href="#interactive-pure-shell" id="id5">5&nbsp;&nbsp;&nbsp;Interactive Pure Shell</a></li>
<li><a class="reference internal" href="#defining-your-own-functions" id="id6">6&nbsp;&nbsp;&nbsp;Defining Your Own Functions</a></li>
<li><a class="reference internal" href="#gnumeric-pure-interface" id="id7">7&nbsp;&nbsp;&nbsp;Gnumeric/Pure Interface</a><ul class="auto-toc">
<li><a class="reference internal" href="#function-descriptions" id="id8">7.1&nbsp;&nbsp;&nbsp;Function Descriptions</a></li>
<li><a class="reference internal" href="#conversions-between-pure-and-gnumeric-values" id="id9">7.2&nbsp;&nbsp;&nbsp;Conversions Between Pure and Gnumeric Values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-features" id="id10">8&nbsp;&nbsp;&nbsp;Advanced Features</a><ul class="auto-toc">
<li><a class="reference internal" href="#calling-gnumeric-from-pure" id="id11">8.1&nbsp;&nbsp;&nbsp;Calling Gnumeric from Pure</a></li>
<li><a class="reference internal" href="#accessing-spreadsheet-cells" id="id12">8.2&nbsp;&nbsp;&nbsp;Accessing Spreadsheet Cells</a></li>
<li><a class="reference internal" href="#asynchronous-data-sources" id="id13">8.3&nbsp;&nbsp;&nbsp;Asynchronous Data Sources</a></li>
<li><a class="reference internal" href="#triggers" id="id14">8.4&nbsp;&nbsp;&nbsp;Triggers</a></li>
<li><a class="reference internal" href="#sheet-objects" id="id15">8.5&nbsp;&nbsp;&nbsp;Sheet Objects</a></li>
<li><a class="reference internal" href="#opengl-interface" id="id16">8.6&nbsp;&nbsp;&nbsp;OpenGL Interface</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Introduction</a></h1>
<p>This package provides a <a class="reference external" href="http://www.gnumeric.org/">Gnumeric</a> extension which gives you access to the
<a class="reference external" href="http://pure-lang.googlecode.com/">Pure</a> programming language in Gnumeric. It works pretty much like the Perl and
Python plugin loaders which are distributed with Gnumeric, but Gnumeric/Pure
offers some powerful features which aren't found in other Gnumeric scripting
plugins:</p>
<ul class="simple">
<li>Pure is a functional programming language which fits the computational model
of spreadsheet programs very well.</li>
<li>Pure is based on term rewriting and thus enables you to do symbolic
computations in addition to the usual numeric calculations.</li>
<li>Pure has a built-in <a class="reference external" href="http://www.mathworks.com/">MATLAB</a>/<a class="reference external" href="http://www.octave.org/">Octave</a>-like matrix data structure which makes
it easy to deal with cell ranges in a spreadsheet in an efficient manner.</li>
<li>Gnumeric/Pure offers support for rendering <a class="reference external" href="http://www.opengl.org/">OpenGL</a> scenes in Gnumeric frame
widgets, via Pure's own OpenGL interface.</li>
<li>Pure also has built-in support for lazy data structures and thus allows you
to handle potentially infinite amounts of data such as the list of all prime
numbers. Gnumeric/Pure lets you turn such lazy values into asynchronous data
sources computed in the background, which update the spreadsheet
automatically as results become available.</li>
<li>Last but not least, Pure is compiled to native code on the fly. This means
that, while startup times are a bit longer due to Pure's JIT compiler
kicking in (you'll notice this if you open a spreadsheet with Pure
functions), the resulting compiled code then typically executes <em>much</em>
faster than equivalent interpreted Perl and Python code.</li>
</ul>
<p>Adding Pure functions to Gnumeric is quite easy. Once the plugin is installed
and enabled, you can simply start adding Pure functions to the provided
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> script, or you can create your own Pure plugin folders.
Gnumeric/Pure also provides a programming interface for use in Pure which
gives you access to various advanced features, such as modifying entire ranges
of cells with one Pure call, calling Gnumeric functions from Pure, and setting
up asynchronous data sources and OpenGL frames. This is all explained in
detail below.</p>
</div>
<div class="section" id="installation">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Installation</a></h1>
<p>Obviously, you need to have both Pure and Gnumeric installed. Pure 0.35 and
Gnumeric 1.19.13 are known to work. We recommend Gnumeric 1.19.14 (only
available in the Gnumeric git repository at the time of this writing) since it
has improved support for GUI widgets. (Older Gnumeric versions probably work
as well if you're willing to fiddle with the Makefile and/or the sources. See
the beginning of the Makefile for related information.)</p>
<p>As shipped, the Makefile is set up to build Gnumeric/Pure with OpenGL support,
which requires that you have the OpenGL libraries as well as <a class="reference external" href="http://gtkglext.sourceforge.net">GtkGLExt</a> (the
Gtk OpenGL extension) installed. These should be readily available on most
systems, but you can also disable this feature by invoking <tt class="docutils literal"><span class="pre">make</span></tt> as <tt class="docutils literal"><span class="pre">make</span>
<span class="pre">GLDEPS=</span></tt>.</p>
<p>Run <tt class="docutils literal"><span class="pre">make</span></tt> to compile the software. You might have to adjust the settings at
the beginning of the Makefile to make this work. If you're lucky and the
compile goes through, you should now have a <tt class="docutils literal"><span class="pre">pure_loader.so</span></tt> file in the
<tt class="docutils literal"><span class="pre">pure-loader</span></tt> subdirectory. You can install the plugin and related stuff
with <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">make</span> <span class="pre">install</span></tt> in the global Gnumeric plugin directory, or if you
prefer to install it into your personal plugin directory then run <tt class="docutils literal"><span class="pre">make</span>
<span class="pre">install-local</span></tt> instead.  (We recommend the latter since it lets you adjust
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> for your purposes more easily.) Optionally, you might also
want to copy the <tt class="docutils literal"><span class="pre">gnumeric-pure.html</span></tt> file to your Pure library directory so
that you can read it with the <tt class="docutils literal"><span class="pre">help</span></tt> command of the Pure interpreter or in
Emacs Pure mode.</p>
<p>Typically, <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt> and <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install-local</span></tt> will install the
plugins into the following directories by default:</p>
<ul class="simple">
<li>System-wide installations go into <tt class="docutils literal"><span class="pre">/usr/local/gnumeric/1.9.13/plugins</span></tt> or
similar, depending on where Gnumeric is installed.</li>
<li>User-specific installations go into <tt class="docutils literal"><span class="pre">~/.gnumeric/1.9.13/plugins</span></tt>.</li>
</ul>
<p>The Makefile tries to guess the installation path and version number of
Gnumeric on its own. If it guesses wrong, you can change these using the
Makefile variables <tt class="docutils literal"><span class="pre">prefix</span></tt> and <tt class="docutils literal"><span class="pre">gnmversion</span></tt>, respectively. For instance:</p>
<pre class="literal-block">
$ make prefix=/usr gnmversion=1.9.13
</pre>
<p>If <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt> doesn't work for some reason, you can also just copy the
<tt class="docutils literal"><span class="pre">pure-func</span></tt>, <tt class="docutils literal"><span class="pre">pure-glfunc</span></tt> and <tt class="docutils literal"><span class="pre">pure-loader</span></tt> directories manually to
your Gnumeric plugin directory.</p>
</div>
<div class="section" id="setup">
<h1><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;Setup</a></h1>
<p>Once Gnumeric/Pure has been properly installed, you should see it in
Gnumeric's Tools/Plug-ins dialog. There are actually two main entries, one
labelled &quot;Pure functions&quot; and the other one labelled &quot;Pure plugin loader&quot;. You
need to enable both before you can start using Pure functions in your Gnumeric
spreadsheets. There's also a third entry labelled &quot;Pure OpenGL functions&quot;
which you might want to enable if you want to try the OpenGL capabilities
(this will only work if you built Gnumeric/Pure with OpenGL support and have
Pure's OpenGL module installed; see <a class="reference internal" href="#opengl-interface">OpenGL Interface</a> for details).</p>
<p>Gnumeric doesn't provide much in the way of GUI customization options right
now, but at least it's possible for plugins to install and configure
additional menu and toolbar options. Gnumeric/Pure adds three additional
options to the Tools menu which allow you to stop asynchronous data sources,
reload Pure scripts and edit them. After installation, the definitions of
these items can be found in the <tt class="docutils literal"><span class="pre">pure-loader/pure-ui.xml</span></tt> file in your
Gnumeric plugin directory. Have a look at this file and edit is as
desired. E.g., if you want to put the Pure-related options into a submenu and
enable toolbar buttons for these options, then your <tt class="docutils literal"><span class="pre">pure-ui.xml</span></tt> file
should look as follows:</p>
<pre class="literal-block">
&lt;ui&gt;
  &lt;menubar&gt;
    &lt;menu name=&quot;Tools&quot; action=&quot;MenuTools&quot;&gt;
      &lt;separator/&gt;
      &lt;menu name=&quot;Pure&quot; action=&quot;PureMenu&quot;&gt;
        &lt;menuitem action=&quot;PureStop&quot;/&gt;
        &lt;menuitem action=&quot;PureReload&quot;/&gt;
        &lt;menuitem action=&quot;PureEdit&quot;/&gt;
      &lt;/menu&gt;
    &lt;/menu&gt;
  &lt;/menubar&gt;
  &lt;toolbar name=&quot;StandardToolbar&quot;&gt;
    &lt;separator/&gt;
    &lt;toolitem action=&quot;PureStop&quot;/&gt;
    &lt;toolitem action=&quot;PureReload&quot;/&gt;
    &lt;toolitem action=&quot;PureEdit&quot;/&gt;
  &lt;/toolbar&gt;
&lt;/ui&gt;
</pre>
</div>
<div class="section" id="basic-usage">
<h1><a class="toc-backref" href="#id4">4&nbsp;&nbsp;&nbsp;Basic Usage</a></h1>
<p>With Pure/Gnumeric installed and enabled, you should be ready to join the fun
now. Start up Gnumeric, click on a cell and invoke the &quot;f(x)&quot; dialog. The Pure
functions available for use are shown in the &quot;Pure&quot; category. E.g., click on
<tt class="docutils literal"><span class="pre">pure_hello</span></tt>. Now the Pure interpreter will be loaded and the function
description displayed. Click &quot;Insert&quot; and then &quot;Ok&quot;. You should now be able to
read the friendly greeting returned by the <tt class="docutils literal"><span class="pre">pure_hello</span></tt> function.</p>
<p>Of course, you can also enter the function call directly as a formula into a
cell as usual. Click on a cell, then enter the following:</p>
<pre class="literal-block">
=pure_hello(getenv(&quot;USER&quot;))
</pre>
<p>The greeting should now be displayed with your login name in it.</p>
<p>Play around a bit with the other Pure functions. These functions are nothing
special; they are just ordinary Pure functions which are defined by the
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> script in the <tt class="docutils literal"><span class="pre">pure-func</span></tt> subdirectory of your Gnumeric
plugin directory. You can have a look at them by invoking the &quot;Edit Pure
Script&quot; option which gets added to the Tools/Pure menu once the Pure plugin
loader is enabled. (This will invoke the emacs editor by default, or the
editor named by the <tt class="docutils literal"><span class="pre">EDITOR</span></tt> environment variable. You can set this
environment variable in your shell's startup files.) The Tools/Pure menu
contains a second Pure-related option, &quot;Reload Pure Scripts&quot; which can be used
to quickly reload all loaded Pure scripts after edits; more about that later.</p>
<p>Please note that most of the functions in <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> are rather
useless, they are only provided for illustrative purposes. However, there are
some useful examples in there, too, in particular:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">pure_eval</span></tt> lets you evaluate any Pure expression, given as a string in
its first argument. E.g., try something like <tt class="docutils literal"><span class="pre">=pure_eval(&quot;foldl</span> <span class="pre">(+)</span> <span class="pre">0</span>
<span class="pre">(1..100)&quot;)</span></tt>. Additional parameters are accessible as <tt class="docutils literal"><span class="pre">x!0</span></tt>, <tt class="docutils literal"><span class="pre">x!1</span></tt>,
etc. For instance: <tt class="docutils literal"><span class="pre">=pure_eval(&quot;x!0+x!1&quot;,A1,B1)</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">pure_echo</span></tt> just displays its arguments as a string in Pure syntax, as the
interpreter sees them. This is useful for debugging purposes. E.g.,
<tt class="docutils literal"><span class="pre">=pure_echo(A1:B10)</span></tt> shows the given range as a Pure matrix.</li>
<li><tt class="docutils literal"><span class="pre">pure_shell</span></tt> is a variation of <tt class="docutils literal"><span class="pre">pure_eval</span></tt> which executes arbitrary Pure
code and returns the last evaluated expression (if any) as a string. This is
mainly provided as a convenience to create an &quot;interactive Pure shell&quot; which
lets you evaluate Pure code inside Gnumeric. To these ends, simply prepare a
text cell for entering the code to be evaluated, and then apply
<tt class="docutils literal"><span class="pre">pure_shell</span></tt> on this text cell in another cell to display the result.</li>
</ul>
<p>A spreadsheet showing most of the predefined functions in action can be found
in <tt class="docutils literal"><span class="pre">pure-examples.gnumeric</span></tt> example distributed with Gnumeric/Pure.</p>
</div>
<div class="section" id="interactive-pure-shell">
<h1><a class="toc-backref" href="#id5">5&nbsp;&nbsp;&nbsp;Interactive Pure Shell</a></h1>
<p>The <tt class="docutils literal"><span class="pre">pure-examples.gnumeric</span></tt> spreadsheet also includes an instance of
<tt class="docutils literal"><span class="pre">pure_shell</span></tt> which lets you evaluate arbitrary Pure code in the same
interpreter instance that executes Gnumeric/Pure functions. This is very
helpful if you're developing new Pure functions to be used in Gnumeric. It
also lets you use Gnumeric as a kind of GUI frontend to the Pure
interpreter. You can try this now. Open the <tt class="docutils literal"><span class="pre">pure-examples</span></tt> spreadsheet in
Gnumeric and enter the following into the input cell of the Pure shell:</p>
<pre class="literal-block">
&gt; scanl (+) 0 (1..20)
  [0,1,3,6,10,15,21,28,36,45,55,66,78,91,105,120,136,153,171,190,210]
</pre>
<p>Note that here and in the following the prompt <tt class="docutils literal"><span class="pre">&gt;</span></tt> indicates a Pure
expression to be evaluated in <em>Gnumeric</em> (rather than the standalone Pure
interpreter), which is followed by another line indicating the result (printed
in the output cell below the input cell of the Pure shell). You can find the
Pure shell at the bottom of the first sheet in <tt class="docutils literal"><span class="pre">pure-examples</span></tt>, see the
screenshot below. For your convenience, there's also a second, bigger one on
the second sheet. You might want to copy this over to a separate spreadsheet
which you can use as a scratchpad for experimentation purposes.</p>
<div class="figure">
<img alt="shell.png" src="shell.png" />
<p class="caption">The Pure shell.</p>
</div>
<p>Also note that this in fact <em>Pure code</em> (not a Gnumeric formula) being
evaluated there. You can execute any Pure code, including Pure declarations,
so you can type:</p>
<pre class="literal-block">
&gt; using system; puts &quot;Hello, world!&quot;;
  14
</pre>
<p>This prints the string <tt class="docutils literal"><span class="pre">&quot;Hello,</span> <span class="pre">world!&quot;</span></tt> on standard output, visible in the
terminal window where you launched Gnumeric. Here is another example, showing
how you can invoke any function from the C library, by declaring it as a Pure
<tt class="docutils literal"><span class="pre">extern</span></tt> function:</p>
<pre class="literal-block">
&gt; extern int rand(); [rand | i = 1..5];
  [1810821799,2106746672,1436605662,1363610028,695042099]
</pre>
<p>All functions in the Pure prelude are readily available in the Gnumeric Pure
shell, as well as the functions defined in <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> and its imports,
including the programming interface described in <a class="reference internal" href="#advanced-features">Advanced Features</a>. For
instance, here's how you can retrieve a cell value from the current sheet:</p>
<pre class="literal-block">
&gt; get_cell &quot;A1&quot;
  &quot;Gnumeric/Pure Examples&quot;
</pre>
<p>Using <tt class="docutils literal"><span class="pre">call</span></tt> (see <a class="reference internal" href="#calling-gnumeric-from-pure">Calling Gnumeric from Pure</a>), you can also invoke any
Gnumeric function:</p>
<pre class="literal-block">
&gt; call &quot;product&quot; (1..10)
  3628800.0
</pre>
</div>
<div class="section" id="defining-your-own-functions">
<h1><a class="toc-backref" href="#id6">6&nbsp;&nbsp;&nbsp;Defining Your Own Functions</a></h1>
<p>After playing around with <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> and the interactive Pure shell
for a while, of course you will want to write your own functions, that's what
this plugin is about after all! For the beginning, you can just add your
definitions to the existing <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> script. Use the &quot;Edit Pure
Script&quot; option to edit the script in your favourite editor, and see the
comments and the examples in the script for guidance. (This document assumes
that you're already familiar with Pure, if not then you should consult the
available Pure documentation.)</p>
<p>Note that if you delete or rename any functions in this file, or add new ones
to it, then you also have to change the list of function names in the
plugin.xml file in the same directory accordingly. This file tells Gnumeric
which functions are provided by the script. Unfortunately, you'll have to
restart Gnumeric to make changes in this file take effect. If you only change
the definition of an existing function then it's usually sufficient to just
invoke &quot;Reload Pure Scripts&quot; afterwards, and maybe run &quot;Recalculate&quot; (<tt class="docutils literal"><span class="pre">F9</span></tt>)
to recompute the spreadsheet. However, if you also made changes to the
function descriptions provided via <tt class="docutils literal"><span class="pre">gnm_info</span></tt> (see the following section for
explanation), then you'll also have to restart Gnumeric so that it picks up
the changes.</p>
<p>Once you understand how this works, you can also create your own plugin
directories with your personal collections of Gnumeric/Pure functions, using
the <tt class="docutils literal"><span class="pre">pure-func</span></tt> directory as a template. For instance, let's assume that
your Gnumeric/Pure stuff is in a script named <tt class="docutils literal"><span class="pre">gnumeric.pure</span></tt> under
<tt class="docutils literal"><span class="pre">/some/path/pure/gnumeric</span></tt>. The plugin.xml file in that directory might look
as follows:</p>
<pre class="literal-block">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;plugin id=&quot;Gnumeric_MyPureFunc&quot;&gt;
  &lt;information&gt;
    &lt;name&gt;My Pure functions&lt;/name&gt;
    &lt;description&gt;My Pure functions for use in Gnumeric.&lt;/description&gt;
    &lt;require_explicit_enabling/&gt;
  &lt;/information&gt;
  &lt;loader type=&quot;Gnumeric_PureLoader:pure&quot;&gt;
    &lt;attribute value=&quot;gnumeric&quot; name=&quot;module_name&quot;/&gt;
  &lt;/loader&gt;
  &lt;services&gt;
    &lt;service type=&quot;function_group&quot; id=&quot;my_pure_func&quot;&gt;
      &lt;category&gt;Pure&lt;/category&gt;
      &lt;functions&gt;
        &lt;!-- My Pure functions go here, e.g.: --&gt;
        &lt;function name=&quot;my_pure_func&quot;/&gt;
      &lt;/functions&gt;
    &lt;/service&gt;
  &lt;/services&gt;
&lt;/plugin&gt;
</pre>
<p>The following steps are needed to tell Gnumeric about your new Pure plugin:</p>
<ul class="simple">
<li>Open the Directories tab in the Tools/Plug-ins dialog and check that the
<tt class="docutils literal"><span class="pre">/some/path/pure</span></tt> directory is in your plugin search path. Add it if
necessary, and restart Gnumeric after that. (Note that you really have to
add the <em>parent</em> directory <tt class="docutils literal"><span class="pre">/some/path/pure</span></tt>, not
<tt class="docutils literal"><span class="pre">/some/path/pure/gnumeric</span></tt> itself.)</li>
<li>The new plugin should now be listed as &quot;My Pure functions&quot; on the Plugin
List tab in the Tools/Plug-ins dialog. Check it to enable it.</li>
</ul>
<p>The Pure loader can load multiple Pure plugins. You only need to tell Gnumeric
about them after creating the scripts and plugin.xml files and placing them
into corresponding plugin directories. Just enable the ones that you want in
Tools/Plug-ins. All scripts are loaded in the same Pure interpreter (and thus
are treated like one big script) so that functions in one script can use the
function and variable definitions in another. If you need to access the
definitions in the <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> &quot;mother script&quot;, you can also just
import it into your scripts with a <tt class="docutils literal"><span class="pre">using</span></tt> clause, i.e.: <tt class="docutils literal"><span class="pre">using</span> <span class="pre">pure_func;</span></tt></p>
</div>
<div class="section" id="gnumeric-pure-interface">
<h1><a class="toc-backref" href="#id7">7&nbsp;&nbsp;&nbsp;Gnumeric/Pure Interface</a></h1>
<p>By default, when a Pure function is called from Gnumeric, it receives its
arguments in a list. However, it is possible to tell Gnumeric about the
expected arguments of the function and also specify a help text to be
displayed in the &quot;f(x)&quot; dialog, by giving a definition of the special
<tt class="docutils literal"><span class="pre">gnm_info</span></tt> function as explained below.</p>
<div class="section" id="function-descriptions">
<h2><a class="toc-backref" href="#id8">7.1&nbsp;&nbsp;&nbsp;Function Descriptions</a></h2>
<p>To describe a given function to Gnumeric, define <tt class="docutils literal"><span class="pre">gnm_info</span> <span class="pre">&quot;&lt;name&gt;&quot;</span></tt> (where
<tt class="docutils literal"><span class="pre">&lt;name&gt;</span></tt> is the name of the function) as a pair with the following elements:</p>
<ul class="simple">
<li>The first element, a string, gives the signature of the function. E.g.,
<tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> denotes a function without arguments, <tt class="docutils literal"><span class="pre">&quot;f&quot;</span></tt> a function taking a
single float parameter, <tt class="docutils literal"><span class="pre">&quot;fs&quot;</span></tt> a function taking a float and a string
argument (in that order), etc. Optional parameters can be indicated using
<tt class="docutils literal"><span class="pre">|</span></tt>, as in <tt class="docutils literal"><span class="pre">&quot;ff|s&quot;</span></tt> (two non-optional floats, followed by an optional
string). See below for a complete list of the supported parameter types.</li>
<li>The second element is a list of hash pairs <tt class="docutils literal"><span class="pre">key=&gt;text</span></tt> which together make
up the help text shown in Gnumeric's &quot;f(x)&quot; dialog. You should at least
specify the function name along with a short synopsis here, e.g.
<tt class="docutils literal"><span class="pre">GNM_FUNC_HELP_NAME</span> <span class="pre">=&gt;</span> <span class="pre">&quot;frob:the</span> <span class="pre">frob</span> <span class="pre">function&quot;</span></tt>. Parameter descriptions
take the form <tt class="docutils literal"><span class="pre">GNM_FUNC_HELP_ARG</span> <span class="pre">=&gt;</span> <span class="pre">&quot;x:integer&quot;</span></tt>. There are a number of
other useful elements, see below for details.</li>
</ul>
<p>Both the signature and the function description are optional. That is,
<tt class="docutils literal"><span class="pre">gnm_info</span></tt> may return either just a signature string, or a list of hash
pairs with the function description, or both. The signature defaults to a
variadic function which takes any number of parameters of any type (see
below), and the description defaults to some boilerplate text which says that
the function hasn't been documented yet.</p>
<p>Note that if no signature is given, then the function accepts any number of
parameters of any type. In that case, or if there are optional parameters, the
function becomes variadic and the (optional) parameters are passed as a Pure
list (in addition to the non-optional parameters).</p>
<p>Here's the list of valid parameter types, as they are documented in the
Gnumeric sources:</p>
<pre class="literal-block">
f : float           no errors, string conversion attempted
b : boolean         identical to f
s : string          no errors
S : scalar          any non-error scalar
E : scalar          any scalar, including errors

r : cell range      content may not be evaluated yet
A : area            array, range (as above), or scalar
? : anything        any value (scalars, non-scalars, errors, whatever)
</pre>
<p>The keys used in the function description may be any of the following, along
with sample text for each type of field:</p>
<pre class="literal-block">
GNM_FUNC_HELP_NAME         =&gt; &quot;name:synopsis&quot;
GNM_FUNC_HELP_ARG          =&gt; &quot;name:parameter description&quot;
GNM_FUNC_HELP_DESCRIPTION  =&gt; &quot;Long description.&quot;
GNM_FUNC_HELP_NOTE         =&gt; &quot;Note.&quot;
GNM_FUNC_HELP_EXAMPLES     =&gt; &quot;=sample_formula()&quot;
GNM_FUNC_HELP_SEEALSO      =&gt; &quot;foo,bar,...&quot;
</pre>
<p>The following keys are only supported in the latest Gnumeric versions:</p>
<pre class="literal-block">
GNM_FUNC_HELP_EXTREF       =&gt; &quot;wiki:en:Trigonometric_functions&quot;
GNM_FUNC_HELP_EXCEL        =&gt; &quot;Excel compatibility information.&quot;
GNM_FUNC_HELP_ODF          =&gt; &quot;OpenOffice compatibility information.&quot;
</pre>
<p>Note that inside the descriptions, the notation <tt class="docutils literal"><span class="pre">&#64;{arg}</span></tt> (<tt class="docutils literal"><span class="pre">&#64;arg</span></tt> in older
Gnumeric versions) can be used to refer to a parameter value. For instance,
here's a sample description for a binary function which also includes a help
text:</p>
<pre class="literal-block">
gnm_info &quot;pure_max&quot; = &quot;ff&quot;,
[GNM_FUNC_HELP_NAME     =&gt; &quot;pure_max:maximum of two numbers&quot;,
 GNM_FUNC_HELP_ARG      =&gt; &quot;x:number&quot;,
 GNM_FUNC_HELP_ARG      =&gt; &quot;y:number&quot;,
 GNM_FUNC_HELP_DESCRIPTION =&gt;
 &quot;Computes the maximum of two numbers &#64;{x} and &#64;{y}.&quot;,
 GNM_FUNC_HELP_EXAMPLES =&gt; &quot;=pure_max(17,22)&quot;];
</pre>
<p>As you can see, the function descriptions are a bit unwieldy, so it's
convenient to construct them using this little helper function defined in
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt>:</p>
<pre class="literal-block">
gnm_help name::string args descr::string notes examples see_also =
  [GNM_FUNC_HELP_NAME         =&gt; name] +
  [GNM_FUNC_HELP_ARG          =&gt; x | x::string = args ] +
  [GNM_FUNC_HELP_DESCRIPTION  =&gt; descr ] +
  [GNM_FUNC_HELP_NOTE         =&gt; x | x::string = notes ] +
  [GNM_FUNC_HELP_EXAMPLES     =&gt; x | x::string = examples ] +
  (if null see_also then [] else
   [GNM_FUNC_HELP_SEEALSO     =&gt; join &quot;,&quot; see_also]);
</pre>
<p>Now the description can be written simply as follows:</p>
<pre class="literal-block">
gnm_info &quot;pure_max&quot; = &quot;ff&quot;, gnm_help &quot;pure_max:maximum of two numbers&quot;
  [&quot;x:number&quot;, &quot;y:number&quot;]
  &quot;Computes the maximum of two numbers &#64;{x} and &#64;{y}.&quot;
  [] [&quot;=pure_max(17,22)&quot;] [];
</pre>
<p>Since this function only has fixed arguments, it will be called in curried
form, i.e., as <tt class="docutils literal"><span class="pre">pure_max</span> <span class="pre">x</span> <span class="pre">y</span></tt>. For instance, the actual definition of
<tt class="docutils literal"><span class="pre">pure_max</span></tt> may look as follows:</p>
<pre class="literal-block">
pure_max x y = max x y;
</pre>
<p>Conversely, if no signature is given, then the function accepts any number of
parameters of any type, which are passed as a list. For instance:</p>
<pre class="literal-block">
gnm_info &quot;pure_sum&quot; = gnm_help &quot;pure_sum:sum of a collection of numbers&quot;
  [] &quot;Computes the sum of a collection of numbers.&quot;
  [] [&quot;=pure_sum(1,2,3,4,5,6)&quot;] [&quot;pure_sums&quot;];
</pre>
<p>Here the function will be called as <tt class="docutils literal"><span class="pre">pure_sum</span> <span class="pre">[x1,x2,...]</span></tt>, where <tt class="docutils literal"><span class="pre">x1</span></tt>,
<tt class="docutils literal"><span class="pre">x2</span></tt>, etc. are the arguments the function is invoked with. Note that in this
case there may be any number of arguments (including zero) of any type, so
your function definition must be prepared to handle this. If a function does
not have a <tt class="docutils literal"><span class="pre">gnm_info</span></tt> description at all then it is treated in the same
fashion. The <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> script contains some examples showing how to
write functions which can deal with any numbers of scalars, arrays or ranges,
see the <tt class="docutils literal"><span class="pre">pure_sum</span></tt> and <tt class="docutils literal"><span class="pre">pure_sums</span></tt> examples. These employ the following
<tt class="docutils literal"><span class="pre">ranges</span></tt> function to &quot;flatten&quot; a parameter list to a list holding all
denoted values:</p>
<pre class="literal-block">
ranges xs = cat [ case x of _::matrix = list x; _ = [x] end | x = xs ];
</pre>
<p>E.g., the <tt class="docutils literal"><span class="pre">pure_sum</span></tt> function can now be defined as follows:</p>
<pre class="literal-block">
pure_sum xs = foldl (+) 0 (ranges xs);
</pre>
<p>A function may also have both fixed and optional arguments (note that in what
follows we're going to omit the detailed function descriptions for brevity):</p>
<pre class="literal-block">
gnm_info &quot;foo&quot; = &quot;ff|ff&quot;;
</pre>
<p>In this case the fixed arguments are passed in curried form as usual, while
the optional parameters are passed as a list. That is, <tt class="docutils literal"><span class="pre">foo</span></tt> may be called
as <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[]</span></tt>, <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[z]</span></tt> or <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[z,t]</span></tt>, depending on whether
it is invoked with two, three or four arguments.</p>
</div>
<div class="section" id="conversions-between-pure-and-gnumeric-values">
<h2><a class="toc-backref" href="#id9">7.2&nbsp;&nbsp;&nbsp;Conversions Between Pure and Gnumeric Values</a></h2>
<p>The marshalling of types between Gnumeric and Pure is pretty straightforward;
basically, Pure numbers, strings and matrices map to Gnumeric numbers, strings
and arrays, respectively. The following table summarizes the available
conversions:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Pure</th>
<th class="head">Gnumeric</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">gnm_error</span> <span class="pre">&quot;#N/A&quot;</span></tt></td>
<td>error</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">4711</span></tt>, <tt class="docutils literal"><span class="pre">4711L</span></tt>, <tt class="docutils literal"><span class="pre">4711.0</span></tt></td>
<td>scalar (number)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">&quot;Hello</span> <span class="pre">world&quot;</span></tt></td>
<td>string</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">()</span></tt></td>
<td>empty</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">(1,2,3)</span></tt></td>
<td>array</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">[1,2,3]</span></tt></td>
<td>array</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">{1,2,3;4,5,6}</span></tt></td>
<td>array (or cell range)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">&quot;A1:B10&quot;</span></tt></td>
<td>cell range (<tt class="docutils literal"><span class="pre">&quot;r&quot;</span></tt> conversion)</td>
</tr>
</tbody>
</table>
<p>These conversions mostly work both ways. Note that on input, cell ranges are
usually passed as matrices to Pure functions (i.e., they are passed &quot;by
value&quot;), unless the function signature specifies a <tt class="docutils literal"><span class="pre">&quot;r&quot;</span></tt> conversion in which
case the cell ranges themselves are passed to the function in string form.
(Such values can also be passed on to Gnumeric functions which expect a cell
range (<tt class="docutils literal"><span class="pre">&quot;r&quot;</span></tt> ) parameter, see <a class="reference internal" href="#calling-gnumeric-from-pure">Calling Gnumeric from Pure</a> below.)</p>
<p>Conversely, matrices, lists and tuples all become Gnumeric arrays on output,
so usually you'll want to enter these as array functions (<tt class="docutils literal"><span class="pre">Ctrl-Shift-Enter</span></tt>
in Gnumeric). As a special case, the empty tuple can be used to denote empty
cell values (but note that empty Gnumeric values may become zeros when passed
as float or array arguments to Pure functions).</p>
<p>If a Pure function returns a value that doesn't match any of the above then it
is converted to a string in Pure expression syntax and that string is returned
as the result of the function invocation in Gnumeric. This makes it possible
to return any kind of symbolic Pure value, but note that if such a value is
then fed into another Pure function, that function will have to convert the
string value back to the internal representation if needed; this can be done
very conveniently using Pure's <tt class="docutils literal"><span class="pre">eval</span></tt> function, see the Pure documentation
for details.</p>
</div>
</div>
<div class="section" id="advanced-features">
<h1><a class="toc-backref" href="#id10">8&nbsp;&nbsp;&nbsp;Advanced Features</a></h1>
<p>This section explains various additional features provided by the
Gnumeric/Pure interface that should be useful for writing your own functions.
Note that, for your convenience all functions discussed in this section are
declared in <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt>.</p>
<div class="section" id="calling-gnumeric-from-pure">
<h2><a class="toc-backref" href="#id11">8.1&nbsp;&nbsp;&nbsp;Calling Gnumeric from Pure</a></h2>
<p>It is possible to call Gnumeric functions from Pure using the <tt class="docutils literal"><span class="pre">call</span></tt>
function which takes the name of the function (a string) as its first, and the
parameters as the second (list) argument. For instance:</p>
<pre class="literal-block">
gnm_info &quot;gnm_bitand&quot; = &quot;ff&quot;;
gnm_bitand x y = call &quot;bitand&quot; [x,y];
</pre>
<p>Note that <tt class="docutils literal"><span class="pre">call</span></tt> is an external C function provided by Gnumeric/Pure. If
you want to use it, it must be declared in your Pure script as follows:</p>
<pre class="literal-block">
extern expr* pure_gnmcall(char* name, expr* args) = call;
</pre>
<p>However, <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> already contains the above declaration, so you
don't have to do this yourself if you import <tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> in your
scripts.</p>
<p>Also note that <tt class="docutils literal"><span class="pre">call</span></tt> doesn't do any of Gnumeric's automatic conversions on
the parameters, so you have to pass the proper types of arguments as required
by the function.</p>
</div>
<div class="section" id="accessing-spreadsheet-cells">
<h2><a class="toc-backref" href="#id12">8.2&nbsp;&nbsp;&nbsp;Accessing Spreadsheet Cells</a></h2>
<p>Gnumeric/Pure provides the following functions to retrieve and modify the
contents of spreadsheet cells and ranges of such cells:</p>
<pre class="literal-block">
extern expr* pure_get_cell(char* s) = get_cell;
extern expr* pure_set_cell(char* s, expr *x) = set_cell;
extern expr* pure_set_cell_text(char* s, expr *x) = set_cell_text;
extern expr* pure_get_range(char* s) = get_range;
extern expr* pure_set_range(char* s, expr *x) = set_range;
extern expr* pure_set_range_text(char* s, expr *x) = set_range_text;
</pre>
<p>For instance, here's how you use these functions to write and then read some
cell values (try this in the interactive Pure shell):</p>
<pre class="literal-block">
&gt; set_cell &quot;A14&quot; 42
  ()
&gt; get_cell &quot;A14&quot;
  42.0
&gt; set_range &quot;A14:G14&quot; $ scanl (*) 1 (1..6)
  ()
&gt; get_range &quot;A14:G14&quot;
  {1.0,1.0,2.0,6.0,24.0,120.0,720.0}
&gt; set_cell_text &quot;A14&quot; &quot;=sum(B14:G14)&quot;
  ()
&gt; get_cell &quot;A14&quot;
  873.0
</pre>
<p>Note that while the <tt class="docutils literal"><span class="pre">set_cell</span></tt> function sets the given cell to a constant
value, <tt class="docutils literal"><span class="pre">set_cell_text</span></tt> also allows you to store a formula in a cell which
will then be evaluated as usual. The <tt class="docutils literal"><span class="pre">set_range</span></tt>, <tt class="docutils literal"><span class="pre">set_range_text</span></tt> and
<tt class="docutils literal"><span class="pre">get_range</span></tt> functions work analogous to <tt class="docutils literal"><span class="pre">set_cell</span></tt>, <tt class="docutils literal"><span class="pre">set_cell_text</span></tt> and
<tt class="docutils literal"><span class="pre">get_cell</span></tt>, but are used to manipulate entire ranges of cells, which can be
set from Pure tuples, lists or matrices, and retrieved as Pure matrices.</p>
<p>There are also functions to get the position of the &quot;current&quot; cell (i.e., the
cell from which a Pure function was called), and to translate between cell
ranges in Gnumeric syntax and the corresponding internal representation
consisting of a pointer to a Gnumeric sheet and the cell or range
coordinates:</p>
<pre class="literal-block">
extern expr* pure_this_cell() = this_cell;
extern expr* pure_parse_range(char* s) = parse_range;
extern expr* pure_make_range(expr* x) = make_range;
</pre>
<p>Examples:</p>
<pre class="literal-block">
&gt; this_cell
  &quot;B4&quot;
&gt; parse_range this_cell
  #&lt;pointer 0x875220&gt;,1,3
&gt; make_range (NULL,0,0,10,10)
  &quot;Sheet2!A1:K11&quot;
</pre>
</div>
<div class="section" id="asynchronous-data-sources">
<h2><a class="toc-backref" href="#id13">8.3&nbsp;&nbsp;&nbsp;Asynchronous Data Sources</a></h2>
<p>Gnumeric/Pure makes it easy to set up asynchronous data sources which draw
values from a Pure computation executed in a background process. This facility
is useful to carry out lengthy computations in the background while you can
continue to work with your spreadsheet. It also allows you to process incoming
data and asynchronous events from special devices (MIDI, sensors, stock
tickers, etc.) in (soft) realtime.</p>
<p>To do this, you simply pass an expression to the <tt class="docutils literal"><span class="pre">datasource</span></tt> function. This
is another external C function provided by Gnumeric/Pure, which is declared in
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> as follows:</p>
<pre class="literal-block">
extern expr* pure_datasource(expr* x) = datasource;
</pre>
<p>The argument to <tt class="docutils literal"><span class="pre">datasource</span></tt> is typically a thunk or stream (lazy list)
which is to be evaluated in the background. The call to <tt class="docutils literal"><span class="pre">datasource</span></tt>
initially returns a <tt class="docutils literal"><span class="pre">#N/A</span></tt> value (<tt class="docutils literal"><span class="pre">gnm_error</span> <span class="pre">&quot;#N/A&quot;</span></tt>) while the
computation is still in progress. The cell containing the data source then
gets updated automatically as soon as the value becomes available, at which
point the <tt class="docutils literal"><span class="pre">datasource</span></tt> call now returns the computed value. E.g., here's how
you would wrap up a lengthy calculation as a thunk and submit it to
<tt class="docutils literal"><span class="pre">datasource</span></tt> which carries out the computation as a background task:</p>
<pre class="literal-block">
gnm_info &quot;pure_frob&quot; = &quot;f&quot;;
pure_frob x = datasource (lengthy_calculation x&amp;);
lengthy_calculation x = sleep 3 $$ foldl (*) 1 (1..x);
</pre>
<p>Note that a cell value may draw values from as many independent data sources
as you want, so the definition of a cell may also involve multiple invocations
of <tt class="docutils literal"><span class="pre">datasource</span></tt>:</p>
<pre class="literal-block">
gnm_info &quot;pure_frob2&quot; = &quot;ff&quot;;
pure_frob2 x y = datasource (lengthy_calculation x&amp;),
  datasource (lengthy_calculation y&amp;);
</pre>
<p>Special treatment is given to (lazy) lists, in this case <tt class="docutils literal"><span class="pre">datasource</span></tt>
returns a new value each time a list element becomes available. For instance,
the following function uses an infinite stream to count off the seconds
starting from a given initial value:</p>
<pre class="literal-block">
gnm_info &quot;pure_counter&quot; = &quot;f&quot;;
pure_counter x = datasource [sleep (i&gt;x) $$ i | i = x..inf];
</pre>
<p>You can also try this interactively in the Pure shell:</p>
<pre class="literal-block">
&gt; datasource [sleep (i&gt;0) $$ i | i = 0..inf]
  0
  1
  ...
</pre>
<p>Here's another example for the Pure shell which prints the prime numbers:</p>
<pre class="literal-block">
&gt; datasource primes with primes = sieve (2..inf);
    sieve (p:qs) = p : (sleep 1 $$ sieve [q | q = qs; q mod p])&amp; end
  2
  3
  5
  ...
</pre>
<p>Note that when processing a lazy list, the cell containing the call will keep
changing as long as new values are produced (i.e., forever in this
example). The &quot;Stop Data Sources&quot; option in the Tools/Pure menu can be used to
stop all active data sources. &quot;Reload Pure Scripts&quot; also does this. You can
then restart the data sources at any time by using &quot;Recalculate&quot; (<tt class="docutils literal"><span class="pre">F9</span></tt>) to
recompute the spreadsheet.</p>
<p>Also note that because of the special way that <tt class="docutils literal"><span class="pre">datasource</span></tt> handles list
values, you cannot return a list directly as the result of <tt class="docutils literal"><span class="pre">datasource</span></tt>, if
it is to be treated as a single result. Instead, you'll have to wrap the
result in a singleton list (e.g., <tt class="docutils literal"><span class="pre">datasource</span> <span class="pre">[[lengthy_calculation</span>
<span class="pre">x,lengthy_calculation</span> <span class="pre">y]&amp;]</span></tt>), or return another aggregate (i.e., a matrix or
a tuple).</p>
<p>Finally, note that when the arguments of a call involving <tt class="docutils literal"><span class="pre">datasource</span></tt>
change (because they depend on other cells which may have been updated), the
computation is automatically restarted with the new parameters. The default
behaviour in this case is that the entire computation will be redone from
scratch, but it's also possible to wrap up calls to <tt class="docutils literal"><span class="pre">datasource</span></tt> in a manner
which enables more elaborate communication between Gnumeric and background
tasks initiated with <tt class="docutils literal"><span class="pre">datasource</span></tt>. This is beyond the scope of this manual,
however, so we leave this as an exercise to the interested reader.</p>
</div>
<div class="section" id="triggers">
<h2><a class="toc-backref" href="#id14">8.4&nbsp;&nbsp;&nbsp;Triggers</a></h2>
<p>In addition to asynchronous data sources, the <tt class="docutils literal"><span class="pre">trigger</span></tt> macro is provided to
compute values or take actions depending on some external condition, such as
the availability of data on a special device or the creation of some widget
(see the next section). The <tt class="docutils literal"><span class="pre">trigger</span></tt> macro is invoked as follows:</p>
<pre class="literal-block">
trigger timeout condition value
</pre>
<p>The <tt class="docutils literal"><span class="pre">condition</span></tt> and <tt class="docutils literal"><span class="pre">value</span></tt> arguments are implicitly quoted. The trigger
reevaluates the given condition in regular intervals (1 second in the current
implementation) and, as soon as it becomes <tt class="docutils literal"><span class="pre">true</span></tt>, computes the given value
and returns that value as the result of the <tt class="docutils literal"><span class="pre">trigger</span></tt> call. As long as the
condition doesn't hold, <tt class="docutils literal"><span class="pre">trigger</span></tt> returns a <tt class="docutils literal"><span class="pre">#N/A</span></tt> value (<tt class="docutils literal"><span class="pre">gnm_error</span>
<span class="pre">&quot;#N/A&quot;</span></tt>). Note that, in difference to <tt class="docutils literal"><span class="pre">datasource</span></tt>, both the condition and
the value are evaluated in Gnumeric (rather than a child process), so that it
is possible to access the current information in the loaded spreadsheet.</p>
<p>The <tt class="docutils literal"><span class="pre">timeout</span></tt> value determines how often the condition is checked. If it is
positive, the condition will be reevaluated <tt class="docutils literal"><span class="pre">timeout+1</span></tt> times (once
initially, and then once per second for a total duration of <tt class="docutils literal"><span class="pre">timeout</span></tt>
seconds). If it is negative, the trigger never times out and the condition
will be checked repeatedly until the trigger expression is removed (or
Gnumeric is exited). In either case the <tt class="docutils literal"><span class="pre">value</span></tt> will be reevaluated each
time the <tt class="docutils literal"><span class="pre">condition</span></tt> is <tt class="docutils literal"><span class="pre">true</span></tt>. (This is most useful if the computed
value, as a side effect, arranges for the condition to become <tt class="docutils literal"><span class="pre">false</span></tt> again
afterwards.) Finally, if <tt class="docutils literal"><span class="pre">timeout</span></tt> is zero then the trigger fires at most
once, as soon as the condition becomes <tt class="docutils literal"><span class="pre">true</span></tt>, at which point the <tt class="docutils literal"><span class="pre">value</span></tt>
is evaluated just once.</p>
<p>Here's a (rather useless) example of a trigger which fires exactly once, as
soon as a certain cell goes to a certain value, and then modifies another cell
value accordingly:</p>
<pre class="literal-block">
&gt; trigger 0 (get_cell &quot;A14&quot;===&quot;Hello&quot;) (set_cell &quot;A15&quot; &quot;World&quot;)
</pre>
<p>Now, as soon as you type <tt class="docutils literal"><span class="pre">Hello</span></tt> in the cell A14, the trigger will print
<tt class="docutils literal"><span class="pre">World</span></tt> in cell A15. A more useful example will be discussed in the
following section.</p>
</div>
<div class="section" id="sheet-objects">
<h2><a class="toc-backref" href="#id15">8.5&nbsp;&nbsp;&nbsp;Sheet Objects</a></h2>
<p>Gnumeric offers some kinds of special objects which can be placed on a
sheet. This comprises the chart and image objects which can be found in the
&quot;Insert&quot; menu, as well as a number of useful graphical elements and GUI
widgets on the &quot;Object&quot; toolbar, accessible via &quot;View/Toolbars&quot;. The latter
are also useful for providing control input to Pure functions.</p>
<p>Gnumeric/Pure provides the following function to retrieve information about
the special objects in a spreadsheet:</p>
<pre class="literal-block">
extern expr* pure_sheet_objects() = sheet_objects;
</pre>
<p>For instance, with one button object in your spreadsheet, the output of
<tt class="docutils literal"><span class="pre">sheet_objects</span></tt> might look like this:</p>
<pre class="literal-block">
&gt; sheet_objects
  [(&quot;Sheet1&quot;,&quot;button&quot;,&quot;Push Me!&quot;,&quot;A11&quot;,[#&lt;pointer 0x2a1dcd0&gt;])]
</pre>
<p>Each object is described by a tuple which lists the name of the sheet on which
the object is located, the type of object, the object's label (if applicable),
the cell which the object is linked to (if applicable), and a list of pointers
to the corresponding <tt class="docutils literal"><span class="pre">GtkWidgets</span></tt> (if any). (Note that in general a GUI
object may be associated with several widgets, as Gnumeric allows you to have
multiple views on the same spreadsheet. There will be one widget for each view
an object is visible in.)</p>
<p>This function is a bit tricky to use in a spreadsheet, however, since some of
the objects or their associated widgets might not have been created yet when
the spreadsheet is loaded. Therefore it is necessary to use a trigger to make
sure that the information is updated once all objects are fully displayed. The
<tt class="docutils literal"><span class="pre">pure_func.pure</span></tt> script contains the following little wrapper around
<tt class="docutils literal"><span class="pre">sheet_objects</span></tt> which does this:</p>
<pre class="literal-block">
pure_objects =
  trigger 0 (all realized sheet_objects) (matrix$map list sheet_objects)
with realized (_,_,_,_,w) = ~listp w || ~null w &amp;&amp; ~any null w end;
</pre>
<p>See the <tt class="docutils literal"><span class="pre">widgets.gnumeric</span></tt> spreadsheet in the distribution for an example.</p>
<p>Possible uses of this facility are left to your imagination. Using Pure's Gtk
interface, you might manipulate the GUI widgets in various ways (add icons to
buttons, add custom child widgets to frames, etc.). One particularly useful
case, for which Gnumeric/Pure has built-in support, is rendering an OpenGL
scene in a Gnumeric frame widget, see below.</p>
</div>
<div class="section" id="opengl-interface">
<h2><a class="toc-backref" href="#id16">8.6&nbsp;&nbsp;&nbsp;OpenGL Interface</a></h2>
<p>Gnumeric/Pure provides special support for rendering OpenGL scenes into
Gnumeric frame widgets. To actually use this, you must have Pure's OpenGL
module installed. The following function is provided to equip a Gnumeric frame
with the OpenGL rendering capability:</p>
<pre class="literal-block">
extern expr *pure_gl_window(char *name, int timeout,
                            expr *setup_cb, expr *config_cb,
                            expr *display_cb, expr *timer_cb,
                            expr *user_data) = gl_window;
</pre>
<p>There's a second function which can be used as a trigger condition to defer
rendering until the target frame widget has been realized:</p>
<pre class="literal-block">
extern bool pure_check_window(char *name) = check_window;
</pre>
<p>Here's an example from <tt class="docutils literal"><span class="pre">pure_glfunc.pure</span></tt> which shows how these functions
are to be used. Have a look at the <tt class="docutils literal"><span class="pre">gl-example.gnumeric</span></tt> spreadsheet
included in the distribution to see this example in action. (You first need to
enable the &quot;Pure OpenGL functions&quot; in the Plugin Manager to make this work.)
The screenshot below shows how the example looks like in Gnumeric.</p>
<div class="figure">
<img alt="opengl.png" src="opengl.png" />
<p class="caption">Gnumeric/Pure OpenGL example.</p>
</div>
<p>The (slightly abridged) code of the example is as follows:</p>
<pre class="literal-block">
using pure_func, GL, GLU;

extern void gdk_gl_draw_teapot(bool solid, double scale);

gnm_info &quot;gltest&quot; = &quot;sbfff&quot;;

gltest frame m a b c = trigger 0 (check_window frame)
  (gl_window frame (m*40) setup config display timer ())
with
  setup _ _ = () when
    // Initialize.
    GL::ClearColor 0.1 0.1 0.3 1.0;
    GL::ShadeModel GL::SMOOTH;
    GL::Enable GL::DEPTH_TEST;
    // Initial projection and modelview matrices.
    GL::MatrixMode GL::PROJECTION;
    GL::LoadIdentity;
    GL::Rotatef 20.0 (-1.0) 0.0 0.0;
    GL::MatrixMode GL::MODELVIEW;
    GL::LoadIdentity;
    // Lighting.
    GL::Lightfv GL::LIGHT0 GL::DIFFUSE {1.0,0.0,0.0,1.0};
    GL::Lightfv GL::LIGHT0 GL::POSITION {2.0,2.0,-5.0,1.0};
    GL::Enable GL::LIGHTING;
    GL::Enable GL::LIGHT0;
  end;
  config _ (w,h) = GL::Viewport 0 0 w h;
  display _ _ = () when
    GL::Clear (GL::DEPTH_BUFFER_BIT or GL::COLOR_BUFFER_BIT);
    gdk_gl_draw_teapot true 0.5;
  end if m;
  display _ _ = () when
    GL::Clear (GL::DEPTH_BUFFER_BIT or GL::COLOR_BUFFER_BIT);
    GL::LoadIdentity;
    GL::Rotatef (scale 360 a) 0.0 1.0 0.0;
    GL::Rotatef (scale 360 b) 1.0 0.0 0.0;
    GL::Rotatef (scale 360 c) 0.0 0.0 1.0;
    gdk_gl_draw_teapot true 0.5;
  end;
  timer _ _ = () when
    GL::Rotatef (scale 36 a) 0.0 1.0 0.0;
    GL::Rotatef (scale 36 b) 1.0 0.0 0.0;
    GL::Rotatef (scale 36 c) 0.0 0.0 1.0;
  end;
  scale step x = (x/100*step);
end;
</pre>
</div>
</div>
</div>
</body>
</html>
