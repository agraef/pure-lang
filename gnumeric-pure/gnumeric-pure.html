<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>Gnumeric/Pure: A Pure Plugin for Gnumeric</title>
<meta name="author" content="Albert Gräf" />
<meta name="copyright" content="Copyright (c) 2009. This software is distributed under the GNU Public License V2 or later, see the COPYING file for details." />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5631 2008-08-24 13:01:23Z goodger $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="gnumeric-pure-a-pure-plugin-for-gnumeric">
<h1 class="title">Gnumeric/Pure: A Pure Plugin for Gnumeric</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Albert Gräf</td></tr>
<tr><th class="docinfo-name">Contact:</th>
<td><a class="first last reference external" href="mailto:Dr.Graef&#64;t-online.de">Dr.Graef&#64;t-online.de</a></td></tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>Copyright (c) 2009. This software is distributed under the GNU
Public License V2 or later, see the COPYING file for details.</td></tr>
</tbody>
</table>
<p>This package provides a Pure plugin loader and a sample script for use with
<a class="reference external" href="http://projects.gnome.org/gnumeric/">Gnumeric</a>. These work pretty much like the Perl and Python plugin loaders
which are distributed with Gnumeric. <a class="reference external" href="http://pure-lang.googlecode.com/">Pure</a> is a functional programming
language based on the term rewriting calculus with good support for math
operations, so it makes for a nice Gnumeric companion. Also, Gnumeric/Pure
brings some features to the table which aren't found in other Gnumeric
scripting plugins, in particular Pure's lazy lists a.k.a. streams of data
which can easily be turned into asychronous data sources computed in the
background.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#installation" id="id1">1&nbsp;&nbsp;&nbsp;Installation</a><ul class="auto-toc">
<li><a class="reference internal" href="#setup" id="id2">1.1&nbsp;&nbsp;&nbsp;Setup</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-usage" id="id3">2&nbsp;&nbsp;&nbsp;Basic Usage</a></li>
<li><a class="reference internal" href="#defining-your-own-functions" id="id4">3&nbsp;&nbsp;&nbsp;Defining Your Own Functions</a></li>
<li><a class="reference internal" href="#gnumeric-pure-interface" id="id5">4&nbsp;&nbsp;&nbsp;Gnumeric/Pure Interface</a><ul class="auto-toc">
<li><a class="reference internal" href="#function-descriptions" id="id6">4.1&nbsp;&nbsp;&nbsp;Function Descriptions</a></li>
<li><a class="reference internal" href="#conversions-between-pure-and-gnumeric-values" id="id7">4.2&nbsp;&nbsp;&nbsp;Conversions Between Pure and Gnumeric Values</a></li>
<li><a class="reference internal" href="#calling-gnumeric-from-pure" id="id8">4.3&nbsp;&nbsp;&nbsp;Calling Gnumeric from Pure</a></li>
<li><a class="reference internal" href="#asynchronous-data-sources" id="id9">4.4&nbsp;&nbsp;&nbsp;Asynchronous Data Sources</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="installation">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Installation</a></h1>
<p>Obviously, you need to have both Pure and Gnumeric installed. Pure 0.35 and
Gnumeric 0.19.12 are known to work, older versions probably work as well if
you fiddle a bit with the Makefile and/or the sources. See the beginning of
the Makefile for detailed instructions. Briefly, you'll have to grab
gnumeric-features.h from the Gnumeric sources and either place it into the
directory with the gnumeric-pure sources, or edit the <tt class="docutils literal"><span class="pre">INCLUDE</span></tt> variable at
the beginning of the Makefile so that gcc finds this header.</p>
<p>Then run <tt class="docutils literal"><span class="pre">make</span></tt>. You might have to adjust the settings at the beginning of
the Makefile to make this work. If you're lucky and the compile goes through,
you should now have a pure_loader.so file in the pure-loader subdirectory. You
can install the plugin and related stuff with <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">make</span> <span class="pre">install</span></tt> in the
global Gnumeric plugin directory, or if you prefer to install it into your
personal plugin directory then run <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install-local</span></tt> instead.  We
recommend the latter since it lets you adjust pure_func.pure for your purposes
more easily. Optionally, you might also want to copy the gnumeric-pure.html
file to your Pure library directory so that you can read it with the <tt class="docutils literal"><span class="pre">help</span></tt>
command of the Pure interpreter or in Emacs Pure mode.</p>
<p>Typically, <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt> and <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install-local</span></tt> will install the
plugins into the following directories by default:</p>
<ul class="simple">
<li>System-wide installations go into /usr/local/gnumeric/1.9.x/plugins or
similar, depending on where Gnumeric is installed.</li>
<li>User-specific installations go into ~/.gnumeric/1.9.x/plugins.</li>
</ul>
<p>The Makefile tries to guess the installation path and version number of
Gnumeric on its own. If it guesses wrong, you can change these using the
Makefile variables <tt class="docutils literal"><span class="pre">prefix</span></tt> and <tt class="docutils literal"><span class="pre">gnmversion</span></tt>, respectively. For instance:</p>
<pre class="literal-block">
$ make prefix=/usr gnmversion=1.9.12
</pre>
<p>If <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt> doesn't work for some reason, you can also just copy the
pure-func and pure-loader directories manually to your Gnumeric plugin
directory.</p>
<div class="section" id="setup">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;Setup</a></h2>
<p>Once Gnumeric/Pure has been properly installed, you should see it in
Gnumeric's <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Plug-ins</span></tt> dialog. As with the Perl and Python plugins,
there are actually two entries, one labelled <tt class="docutils literal"><span class="pre">Pure</span> <span class="pre">functions</span></tt> and the other
one labelled <tt class="docutils literal"><span class="pre">Pure</span> <span class="pre">plugin</span> <span class="pre">loader</span></tt>. You need to enable both before you can
start using Pure functions in your Gnumeric spreadsheets.</p>
<p>Gnumeric doesn't provide much in the way of GUI customization options right
now, but at least it's possible for plugins to install and configure
additional menu and toolbar options. The Pure plugin loader adds three
additional options to the <tt class="docutils literal"><span class="pre">Tools</span></tt> menu which allow you to stop asynchronous
data sources, reload Pure scripts and edit them. After installation, the
definitions of these items can be found in the pure-loader/pure-ui.xml file in
your Gnumeric plugin directory. Have a look at this file and edit is as
desired. E.g., if you want to put the Pure-related options into a submenu and
enable toolbar buttons for these options, then your pure-ui.xml file should
look as follows:</p>
<pre class="literal-block">
&lt;ui&gt;
  &lt;menubar&gt;
    &lt;menu name=&quot;Tools&quot; action=&quot;MenuTools&quot;&gt;
      &lt;separator/&gt;
      &lt;menu name=&quot;Pure&quot; action=&quot;PureMenu&quot;&gt;
        &lt;menuitem action=&quot;PureStop&quot;/&gt;
        &lt;menuitem action=&quot;PureReload&quot;/&gt;
        &lt;menuitem action=&quot;PureEdit&quot;/&gt;
      &lt;/menu&gt;
    &lt;/menu&gt;
  &lt;/menubar&gt;
  &lt;toolbar name=&quot;StandardToolbar&quot;&gt;
    &lt;separator/&gt;
    &lt;toolitem action=&quot;PureStop&quot;/&gt;
    &lt;toolitem action=&quot;PureReload&quot;/&gt;
    &lt;toolitem action=&quot;PureEdit&quot;/&gt;
  &lt;/toolbar&gt;
&lt;/ui&gt;
</pre>
</div>
</div>
<div class="section" id="basic-usage">
<h1><a class="toc-backref" href="#id3">2&nbsp;&nbsp;&nbsp;Basic Usage</a></h1>
<p>With Pure/Gnumeric installed and enabled, you should be ready to join the fun
now. Start up Gnumeric, click on a cell and invoke the <tt class="docutils literal"><span class="pre">f(x)</span></tt> dialog. The
Pure functions available for use are shown in the <tt class="docutils literal"><span class="pre">Pure</span></tt> category. E.g.,
click on <tt class="docutils literal"><span class="pre">pure_hello</span></tt>. Now the Pure interpreter will be loaded and the
function description displayed. Click <tt class="docutils literal"><span class="pre">Insert</span></tt> and then <tt class="docutils literal"><span class="pre">Ok</span></tt>. You should
now be able to read the friendly greeting returned by the <tt class="docutils literal"><span class="pre">pure_hello</span></tt>
function.</p>
<p>Of course, you can also enter the function call directly as a formula into a
cell as usual. Click on a cell, then enter the following:</p>
<pre class="literal-block">
=pure_hello(getenv(&quot;USER&quot;))
</pre>
<p>The greeting should now be displayed with your login name in it.</p>
<p>Play around a bit with the other Pure functions. These functions are nothing
special; they are just ordinary Pure functions which are defined by the
pure_func.pure script in the pure-func subdirectory of your Gnumeric plugin
directory. You can have a look at them by invoking the <tt class="docutils literal"><span class="pre">Edit</span> <span class="pre">Pure</span> <span class="pre">Script</span></tt>
option which gets added to the <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Pure</span></tt> menu once the Pure plugin
loader is enabled. (This will invoke the emacs editor by default, or the
editor named by the <tt class="docutils literal"><span class="pre">EDITOR</span></tt> environment variable. You can set this
environment variable in your shell's startup files.) The <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Pure</span></tt>
menu contains a second Pure-related option, <tt class="docutils literal"><span class="pre">Reload</span> <span class="pre">Pure</span> <span class="pre">Scripts</span></tt> which can
be used to quickly reload all loaded Pure scripts after edits; more about that
later.</p>
<p>Please note that most of the functions in pure_func.pure are rather useless,
they are only provided for illustrative purposes. However, there are some
useful examples in there, too, in particular:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">pure_eval</span></tt> lets you evaluate any Pure expression, given as a string in
its first argument. E.g., try something like <tt class="docutils literal"><span class="pre">=pure_eval(&quot;foldl</span> <span class="pre">(+)</span> <span class="pre">0</span>
<span class="pre">(1..100)&quot;)</span></tt>. Additional parameters are accessible as <tt class="docutils literal"><span class="pre">x!0</span></tt>, <tt class="docutils literal"><span class="pre">x!1</span></tt>,
etc. For instance: <tt class="docutils literal"><span class="pre">=pure_eval(&quot;x!0+x!1&quot;,A1,B1)</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">pure_echo</span></tt> just displays its arguments as a string in Pure syntax, as the
interpreter sees them. This is useful for debugging purposes. E.g.,
<tt class="docutils literal"><span class="pre">=pure_echo(A1:B10)</span></tt> shows the given range as a Pure matrix.</li>
</ul>
<p>A little example spreadsheet showing the predefined functions in action can be
found in pure-examples.gnumeric in the Gnumeric/Pure sources.</p>
</div>
<div class="section" id="defining-your-own-functions">
<h1><a class="toc-backref" href="#id4">3&nbsp;&nbsp;&nbsp;Defining Your Own Functions</a></h1>
<p>After playing around with pure_func.pure for a while, of course you will want
to write your own functions, that's what this plugin is about after all! For
the beginning, you can just add your definitions to the existing
pure_func.pure script. Use the <tt class="docutils literal"><span class="pre">Edit</span> <span class="pre">Pure</span> <span class="pre">Script</span></tt> option to edit the script
in your favourite editor, and see the comments and the examples in the script
for guidance. (This document assumes that you're already familiar with Pure,
if not then you should consult the available Pure documentation.)</p>
<p>Note that if you delete or rename any functions in this file, or add new ones
to it, then you also have to change the list of function names in the
plugin.xml file in the same directory accordingly. This file tells Gnumeric
which functions are provided by the script. Unfortunately, you'll have to
restart Gnumeric to make changes in this file take effect. If you only change
the definition of an existing function then it's usually sufficient to just
invoke <tt class="docutils literal"><span class="pre">Reload</span> <span class="pre">Pure</span> <span class="pre">Scripts</span></tt> afterwards, and maybe run <tt class="docutils literal"><span class="pre">Recalculate</span></tt>
(<tt class="docutils literal"><span class="pre">F9</span></tt>) to recompute the spreadsheet. However, if you also made changes to
the function descriptions provided via <tt class="docutils literal"><span class="pre">gnm_info</span></tt> (see the following section
for explanation), then you'll also have to restart Gnumeric so that it picks
up the changes.</p>
<p>Once you understand how this works, you can also create your own plugin
directories with your personal collections of Gnumeric/Pure functions, using
the pure-func directory as a template. For instance, assume that your
Gnumeric/Pure stuff is in a script named gnumeric.pure in the
$HOME/pure/gnumeric directory, where $HOME is the name of your home
directory. The plugin.xml file in that directory might look as follows:</p>
<pre class="literal-block">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;plugin id=&quot;Gnumeric_MyPureFunc&quot;&gt;
  &lt;information&gt;
    &lt;name&gt;My Pure functions&lt;/name&gt;
    &lt;description&gt;My Pure functions for use in Gnumeric.&lt;/description&gt;
    &lt;require_explicit_enabling/&gt;
  &lt;/information&gt;
  &lt;loader type=&quot;Gnumeric_PureLoader:pure&quot;&gt;
    &lt;attribute value=&quot;gnumeric&quot; name=&quot;module_name&quot;/&gt;
  &lt;/loader&gt;
  &lt;services&gt;
    &lt;service type=&quot;function_group&quot; id=&quot;my_pure_func&quot;&gt;
      &lt;category&gt;Pure&lt;/category&gt;
      &lt;functions&gt;
        &lt;function name=&quot;pure_hello&quot;/&gt;
        &lt;!-- My Pure functions go here... --&gt;
      &lt;/functions&gt;
    &lt;/service&gt;
  &lt;/services&gt;
&lt;/plugin&gt;
</pre>
<p>The following steps are needed to tell Gnumeric about your new Pure plugin:</p>
<ul class="simple">
<li>Open the <tt class="docutils literal"><span class="pre">Directories</span></tt> tab in the <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Plug-ins</span></tt> dialog and add
the $HOME/pure directory to the plugin search path. You might have to
restart Gnumeric after that.</li>
<li>The plugin can now be enabled in the <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Plug-ins</span></tt> dialog under
<tt class="docutils literal"><span class="pre">My</span> <span class="pre">Pure</span> <span class="pre">functions</span></tt>.</li>
</ul>
<p>The Pure loader can also load multiple Pure plugins, after creating the
corresponding plugin directories and scripts just enable the ones that you
want in <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Plug-ins</span></tt>. All scripts are loaded in the same Pure
interpreter (and thus are treated like one big script) so that they can
communicate with each other if necessary.</p>
</div>
<div class="section" id="gnumeric-pure-interface">
<h1><a class="toc-backref" href="#id5">4&nbsp;&nbsp;&nbsp;Gnumeric/Pure Interface</a></h1>
<p>By default, when a Pure function is called from Gnumeric, it receives its
arguments in a list. However, it is possible to tell Gnumeric about the
expected arguments of the function and also specify a help text to be
displayed in the <tt class="docutils literal"><span class="pre">f(x)</span></tt> dialog, by giving a definition of the special
<tt class="docutils literal"><span class="pre">gnm_info</span></tt> function as explained below. In further subsections we explain
various other aspects of the Gnumeric/Pure interface that should be useful for
writing your own functions.</p>
<div class="section" id="function-descriptions">
<h2><a class="toc-backref" href="#id6">4.1&nbsp;&nbsp;&nbsp;Function Descriptions</a></h2>
<p>To describe a given function to Gnumeric, define <tt class="docutils literal"><span class="pre">gnm_info</span> <span class="pre">&quot;&lt;name&gt;&quot;</span></tt> (where
<tt class="docutils literal"><span class="pre">&lt;name&gt;</span></tt> is the name of the function) as a pair with the following elements:</p>
<ul class="simple">
<li>The first element, a string, gives the signature of the function. E.g.,
<tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> denotes a function without arguments, <tt class="docutils literal"><span class="pre">&quot;f&quot;</span></tt> a function taking a
single float parameter, <tt class="docutils literal"><span class="pre">&quot;fs&quot;</span></tt> a function taking a float and a string
argument (in that order), etc. Optional parameters can be indicated using
<tt class="docutils literal"><span class="pre">|</span></tt>, as in <tt class="docutils literal"><span class="pre">&quot;ff|s&quot;</span></tt> (two non-optional floats, followed by an optional
string). See below for a complete list of the supported parameter types.</li>
<li>The second element is a list of hash pairs <tt class="docutils literal"><span class="pre">key=&gt;text</span></tt> which together make
up the help text shown in Gnumeric's <tt class="docutils literal"><span class="pre">f(x)</span></tt> dialog. You should at least
specify the function name along with a short synopsis here, e.g.
<tt class="docutils literal"><span class="pre">GNM_FUNC_HELP_NAME</span> <span class="pre">=&gt;</span> <span class="pre">&quot;frob:the</span> <span class="pre">frob</span> <span class="pre">function&quot;</span></tt>. Parameter descriptions
take the form <tt class="docutils literal"><span class="pre">GNM_FUNC_HELP_ARG</span> <span class="pre">=&gt;</span> <span class="pre">&quot;x:integer&quot;</span></tt>. There are a number of
other useful elements, see below for details.</li>
</ul>
<p>Both the signature and the function description are optional. That is,
<tt class="docutils literal"><span class="pre">gnm_info</span></tt> may return either just a signature string, or a list of hash
pairs with the function description, or both. The signature defaults to a
variadic function which takes any number of parameters of any type (see
below), and the description defaults to some boilerplate text which says that
the function hasn't been documented yet.</p>
<p>Note that if no signature is given, then the function accepts any number of
parameters of any type. In that case, or if there are optional parameters, the
function becomes variadic and the (optional) parameters are passed as a Pure
list (in addition to the non-optional parameters).</p>
<p>Here's the list of valid parameter types, straight from the
writing-functions.sgml file in the Gnumeric sources:</p>
<pre class="literal-block">
b : boolean         identical to f
f : float           no errors, string conversion attempted
s : string          no errors, blanks accepted and passed as empty
S : scalar          any scalar non-error, blanks passed as empty
E : scalar          any scalar non blank value
B : scalar          any scalar even a blank

r : cell range      content is _NOT_ guaranteed to have been evaluated yet
A : area            array, range, (range as above), or scalar
a : array
? : anything
</pre>
<p>The keys used in the function description may be any of the following, along
with sample text for each type of field:</p>
<pre class="literal-block">
GNM_FUNC_HELP_NAME         =&gt; &quot;name:synopsis&quot;
GNM_FUNC_HELP_ARG          =&gt; &quot;name:parameter description&quot;
GNM_FUNC_HELP_DESCRIPTION  =&gt; &quot;Long description.&quot;
GNM_FUNC_HELP_NOTE         =&gt; &quot;Note.&quot;
GNM_FUNC_HELP_EXAMPLES     =&gt; &quot;=sample_formula()&quot;
GNM_FUNC_HELP_SEEALSO      =&gt; &quot;foo,bar,...&quot;
</pre>
<p>The following keys are only supported in the latest Gnumeric versions:</p>
<pre class="literal-block">
GNM_FUNC_HELP_EXTREF       =&gt; &quot;wiki:en:Trigonometric_functions&quot;
GNM_FUNC_HELP_EXCEL        =&gt; &quot;Excel compatibility information.&quot;
GNM_FUNC_HELP_ODF          =&gt; &quot;OpenOffice compatibility information.&quot;
</pre>
<p>Note that inside the descriptions, the notation <tt class="docutils literal"><span class="pre">&#64;{arg}</span></tt> can be used to
refer to a parameter value. For instance, here's a sample description for a
binary function which also includes a help text:</p>
<pre class="literal-block">
gnm_info &quot;pure_max&quot; = &quot;ff&quot;,
[GNM_FUNC_HELP_NAME     =&gt; &quot;pure_max:maximum of two numbers&quot;,
 GNM_FUNC_HELP_ARG      =&gt; &quot;x:number&quot;,
 GNM_FUNC_HELP_ARG      =&gt; &quot;y:number&quot;,
 GNM_FUNC_HELP_DESCRIPTION =&gt;
 &quot;Computes the maximum of two numbers &#64;{x} and &#64;{y}.&quot;,
 GNM_FUNC_HELP_EXAMPLES =&gt; &quot;=pure_max(17,22)&quot;];
</pre>
<p>As you can see, the function descriptions are a bit unwieldy, so it's
convenient to construct them using this little helper function defined in
pure_func.pure:</p>
<pre class="literal-block">
gnm_help name::string args descr::string notes examples see_also =
  [GNM_FUNC_HELP_NAME         =&gt; name] +
  [GNM_FUNC_HELP_ARG          =&gt; x | x::string = args ] +
  [GNM_FUNC_HELP_DESCRIPTION  =&gt; descr ] +
  [GNM_FUNC_HELP_NOTE         =&gt; x | x::string = notes ] +
  [GNM_FUNC_HELP_EXAMPLES     =&gt; x | x::string = examples ] +
  (if null see_also then [] else
   [GNM_FUNC_HELP_SEEALSO     =&gt; join &quot;,&quot; see_also]);
</pre>
<p>Now the description can be written as follows:</p>
<pre class="literal-block">
gnm_info &quot;pure_max&quot; = &quot;ff&quot;, gnm_help &quot;pure_max:maximum of two numbers&quot;
  [&quot;x:number&quot;, &quot;y:number&quot;]
  &quot;Computes the maximum of two numbers &#64;{x} and &#64;{y}.&quot;
  [] [&quot;=pure_max(17,22)&quot;] [];
</pre>
<p>Since this function only has fixed arguments, it will be called in curried
form, i.e., as <tt class="docutils literal"><span class="pre">pure_max</span> <span class="pre">x</span> <span class="pre">y</span></tt>. For instance, the actual definition of
<tt class="docutils literal"><span class="pre">pure_max</span></tt> may look as follows:</p>
<pre class="literal-block">
pure_max x y = max x y;
</pre>
<p>Conversely, if no signature is given, then the function accepts any number of
parameters of any type, which are passed as a list. For instance:</p>
<pre class="literal-block">
gnm_info &quot;pure_sum&quot; = gnm_help &quot;pure_sum:sum of a collection of numbers&quot; []
  &quot;Computes the sum of a collection of numbers.&quot;
  [] [&quot;=pure_sum(1,2,3,4,5,6)&quot;] [&quot;pure_sums&quot;];
</pre>
<p>Here the function will be called as <tt class="docutils literal"><span class="pre">pure_sum</span> <span class="pre">[x1,x2,...]</span></tt>, where <tt class="docutils literal"><span class="pre">x1</span></tt>,
<tt class="docutils literal"><span class="pre">x2</span></tt>, etc. are the arguments the function is invoked with. Note that in this
case there may be any number of arguments (including zero) of any type, so
your function definition must be prepared to handle this. If a function does
not have a <tt class="docutils literal"><span class="pre">gnm_info</span></tt> description at all then it is treated in the same
fashion. The pure_func.pure script contains some examples showing how to write
functions which can deal with any numbers of scalars, arrays or ranges, see
the <tt class="docutils literal"><span class="pre">pure_sum</span></tt> and <tt class="docutils literal"><span class="pre">pure_sums</span></tt> examples. These employ the following
<tt class="docutils literal"><span class="pre">ranges</span></tt> function to &quot;flatten&quot; a parameter list to a list holding all
denoted values:</p>
<pre class="literal-block">
ranges xs = cat [ case x of _::matrix = list x; _ = [x] end | x = xs ];
</pre>
<p>E.g., the <tt class="docutils literal"><span class="pre">pure_sum</span></tt> function can now be defined as follows:</p>
<pre class="literal-block">
pure_sum xs = foldl (+) 0 (ranges xs);
</pre>
<p>A function may also have both fixed and optional arguments (note that in what
follows we're going to omit the detailed function descriptions for brevity):</p>
<pre class="literal-block">
gnm_info &quot;foo&quot; = &quot;ff|ff&quot;;
</pre>
<p>In this case the fixed arguments are passed in curried form as usual, while
the optional parameters are passed as a list. That is, <tt class="docutils literal"><span class="pre">foo</span></tt> may be called
as <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[]</span></tt>, <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[z]</span></tt> or <tt class="docutils literal"><span class="pre">foo</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">[z,t]</span></tt>, depending on whether
it is invoked with two, three or four arguments.</p>
</div>
<div class="section" id="conversions-between-pure-and-gnumeric-values">
<h2><a class="toc-backref" href="#id7">4.2&nbsp;&nbsp;&nbsp;Conversions Between Pure and Gnumeric Values</a></h2>
<p>The marshalling of types between Gnumeric and Pure is pretty straightforward;
basically, Pure numbers, strings and matrices map to Gnumeric numbers, strings
and arrays, respectively. The following table summarizes the available
conversions:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Pure</th>
<th class="head">Gnumeric</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">gnm_error</span> <span class="pre">&quot;#N/A&quot;</span></tt></td>
<td>error</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">4711</span></tt>, <tt class="docutils literal"><span class="pre">4711L</span></tt>, <tt class="docutils literal"><span class="pre">4711.0</span></tt></td>
<td>scalar (number)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">&quot;Hello</span> <span class="pre">world&quot;</span></tt></td>
<td>string</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">()</span></tt></td>
<td>empty</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">(1,2,3)</span></tt></td>
<td>array</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">[1,2,3]</span></tt></td>
<td>array</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">{1,2,3;4,5,6}</span></tt></td>
<td>array (or cell range)</td>
</tr>
</tbody>
</table>
<p>These conversions generally work both ways. Note that on input, cell ranges
are always passed as matrices to Pure functions (i.e., they are passed &quot;by
value&quot; rather than passing the cell references themselves). Conversely,
matrices, lists and tuples all become Gnumeric arrays on output, so usually
you'll want to enter these as array functions (<tt class="docutils literal"><span class="pre">Ctrl-Shift-Enter</span></tt> in
Gnumeric). As a special case, the empty tuple can be used to denote empty cell
values (but note that empty Gnumeric values may become zeros when passed as
float or array arguments to Pure functions).</p>
<p>If a Pure function returns a value that doesn't match any of the above then it
is converted to a string in Pure expression syntax and that string is returned
as the result of the function invocation in Gnumeric. This makes it possible
to return any kind of symbolic Pure value, but note that if such a value is
then fed into another Pure function, that function will have to convert the
string value back to the internal representation if needed; this can be done
very conveniently using Pure's <tt class="docutils literal"><span class="pre">eval</span></tt> function, see the Pure documentation
for details.</p>
</div>
<div class="section" id="calling-gnumeric-from-pure">
<h2><a class="toc-backref" href="#id8">4.3&nbsp;&nbsp;&nbsp;Calling Gnumeric from Pure</a></h2>
<p>It is also possible to call Gnumeric functions from Pure using the
<tt class="docutils literal"><span class="pre">pure_gnmcall</span></tt> function which takes the name of the function (a string) as
its first, and the parameters as the second (list) argument. For instance:</p>
<pre class="literal-block">
gnm_info &quot;gnm_bitand&quot; = &quot;ff&quot;;
gnm_bitand x y = pure_gnmcall &quot;bitand&quot; [x,y];
</pre>
<p>Note that <tt class="docutils literal"><span class="pre">pure_gnmcall</span></tt> is an external C function provided by the Pure
loader. If you want to use it, it must be declared in your Pure script as
follows:</p>
<pre class="literal-block">
extern expr* pure_gnmcall(char* name, expr* args);
</pre>
</div>
<div class="section" id="asynchronous-data-sources">
<h2><a class="toc-backref" href="#id9">4.4&nbsp;&nbsp;&nbsp;Asynchronous Data Sources</a></h2>
<p>Gnumeric/Pure makes it easy to set up asynchronous data sources which draw
values from a Pure computation executed in a background process. This facility
is useful to carry out lengthy computations in the background while you can
continue to work with your spreadsheet. It also allows you to process incoming
data and asynchronous events from special devices (MIDI, sensors, stock
tickers, etc.) in (soft) realtime.</p>
<p>To do this, you simply pass an expression to the <tt class="docutils literal"><span class="pre">pure_datasource</span></tt>
function. This is another external C function provided by the Pure loader,
which is declared in your Pure scripts as follows:</p>
<pre class="literal-block">
extern expr* pure_datasource(expr* x);
</pre>
<p>The argument to <tt class="docutils literal"><span class="pre">pure_datasource</span></tt> is typically a thunk or stream (lazy list)
which is to be evaluated in the background. The call to <tt class="docutils literal"><span class="pre">pure_datasource</span></tt>
initially returns a <tt class="docutils literal"><span class="pre">#N/A</span></tt> value (<tt class="docutils literal"><span class="pre">gnm_error</span> <span class="pre">&quot;#N/A&quot;</span></tt>) while the
computation is still in progress. The cell containing the data source gets
updated automatically as soon as the value becomes available, with
<tt class="docutils literal"><span class="pre">pure_datasource</span></tt> now returning the computed value. E.g., here's how you
would wrap up a lengthy calculation as a thunk and submit it to
<tt class="docutils literal"><span class="pre">pure_datasource</span></tt> which carries out the computation as a background task:</p>
<pre class="literal-block">
gnm_info &quot;pure_frob&quot; = &quot;f&quot;;
pure_frob x = pure_datasource (lengthy_calculation x&amp;);
lengthy_calculation x = sleep 3 $$ foldl (*) 1 (1..x);
</pre>
<p>Note that a cell value may draw values from as many independent data sources
as you want, so the definition of a cell may also involve multiple invocations
of <tt class="docutils literal"><span class="pre">pure_datasource</span></tt>:</p>
<pre class="literal-block">
gnm_info &quot;pure_frob2&quot; = &quot;ff&quot;;
pure_frob2 x y = pure_datasource (lengthy_calculation x&amp;),
  pure_datasource (lengthy_calculation y&amp;);
</pre>
<p>In the case of a (lazy) list, <tt class="docutils literal"><span class="pre">pure_datasource</span></tt> returns a new value each
time the next list element becomes available. For instance, the following
function uses an infinite stream to count off the seconds starting from a
given initial value:</p>
<pre class="literal-block">
gnm_info &quot;pure_counter&quot; = &quot;f&quot;;
pure_counter x = pure_datasource [sleep (i&gt;x) $$ i | i = x..inf];
</pre>
<p>Note that in this case the cell containing the call will keep changing as long
as new values are produced (i.e., forever in the above example). The <tt class="docutils literal"><span class="pre">Stop</span>
<span class="pre">Data</span> <span class="pre">Sources</span></tt> option in the <tt class="docutils literal"><span class="pre">Tools</span></tt>/<tt class="docutils literal"><span class="pre">Pure</span></tt> menu can be used to stop all
active data sources. <tt class="docutils literal"><span class="pre">Reload</span> <span class="pre">Pure</span> <span class="pre">Scripts</span></tt> also does this. You can then
restart the data sources at any time by using <tt class="docutils literal"><span class="pre">Recalculate</span></tt> (<tt class="docutils literal"><span class="pre">F9</span></tt>) to
recompute the spreadsheet.</p>
<p>Also note that because of the special way that <tt class="docutils literal"><span class="pre">pure_datasource</span></tt> handles
list values, you cannot return a list directly as the result of
<tt class="docutils literal"><span class="pre">pure_datasource</span></tt>; instead, you'll have to wrap it up as a singleton list,
such as <tt class="docutils literal"><span class="pre">pure_data_source</span> <span class="pre">[[lengthy_calculation</span> <span class="pre">x,lengthy_calculation</span> <span class="pre">y]&amp;]</span></tt>.</p>
<p>Finally, note that when the arguments of a call involving <tt class="docutils literal"><span class="pre">pure_datasource</span></tt>
change (because they depend on other cells which may have been updated), the
computation is automatically restarted with the new parameters. This will
generally redo the entire computation from scratch, but it's also possible to
wrap up calls to <tt class="docutils literal"><span class="pre">pure_datasource</span></tt> in a manner which enables more elaborate
communication between Gnumeric and background tasks initiated with
<tt class="docutils literal"><span class="pre">pure_datasource</span></tt>. This is beyond the scope of this manual, however, so we
leave this as an exercise to the interested reader.</p>
</div>
</div>
</div>
</body>
</html>
